window.wp=window.wp||{},window.bp=window.bp||{},function(u){"undefined"!=typeof BP_Nouveau&&(_.extend(bp,_.pick(wp,"Backbone","ajax","template")),bp.Models=bp.Models||{},bp.Collections=bp.Collections||{},bp.Views=bp.Views||{},bp.Nouveau=bp.Nouveau||{},bp.Nouveau.SchedulePost={start:function(){this.setupGlobals(),this.viewGroupSchedulePostModal(),this.addListeners()},setupGlobals:function(){this.scheduled_current_page=1},addListeners:function(){u(document).on("click",".bb-view-scheduled-posts",this.openSchedulePostModal),u("#buddypress").on("click",".bb-view-schedule-posts, .bb-view-all-scheduled-posts",this,this.showSchedulePosts),u("#buddypress").on("click","#bb-schedule-posts_modal li.load-more",this.loadMoreScheduledActivities.bind(this)),u(document).on("click",".bb-schedule-posts_modal .activity-item",this.activityActions.bind(this))},activityActions:function(e){var t=u(e.currentTarget),s=u(e.target),i=t.data("bp-activity-id");if(s.closest("span").hasClass("activity-read-more")){var d=s.closest("div"),a=s.closest("span"),l=null;if(u(d).hasClass("activity-inner")?l=i:u(d).hasClass("acomment-content")&&(l=s.closest("li").data("bp-activity-comment-id")),!l)return e;e.preventDefault(),u(a).addClass("loading"),bp.Nouveau.ajax({action:"get_single_activity_content",id:l,status:"scheduled"},"activity").done(function(e){"object"!=typeof e&&0<s.closest("div").find(".bb-activity-media-wrap").length&&(e=JSON.parse(e)),u(a).removeClass("loading"),d.parent().find(".bp-feedback").length&&d.parent().find(".bp-feedback").remove(),!1===e.success?(d.after(e.data.feedback),d.parent().find(".bp-feedback").hide().fadeIn(300)):(u(d).html(e.data.contents).slideDown(300),jQuery(window).scroll(),t.hasClass("wp-link-embed")&&(void 0!==window.instgrm&&window.instgrm.Embeds.process(),void 0!==window.FB)&&void 0!==window.FB.XFBML&&window.FB.XFBML.parse(document.getElementById("activity-"+l)))})}},openSchedulePostModal:function(){bp.Nouveau.SchedulePostView=!0,jQuery(".activity-update-form .activity-form:not(.focus-in) #whats-new").trigger("focus"),setTimeout(function(){u(".bb-schedule-post_dropdown_section").hasClass("bp-hide")&&(bp.Nouveau.SchedulePostViewHidden=!0,u(".bb-schedule-post_dropdown_section").removeClass("bp-hide")),u(".activity-form .bb-schedule-post_dropdown_button").trigger("click"),setTimeout(function(){u(".activity-form .bb-view-schedule-posts").trigger("click")},0)},100)},showSchedulePosts:function(){var e,t="activity";bp.Nouveau.SchedulePost.scheduled_current_page=1,u("#buddypress .bb-action-popup-content .schedule-posts-content").length&&(e={object:t,status:"scheduled",target:"#buddypress .bb-action-popup-content .schedule-posts-content",template:"activity_schedule"},u('#buddypress [data-bp-member-type-filter="'+t+'"]').length?e.member_type_id=u('#buddypress [data-bp-member-type-filter="'+t+'"]').val():u('#buddypress [data-bp-group-type-filter="'+t+'"]').length&&(e.group_type=u('#buddypress [data-bp-group-type-filter="'+t+'"]').val()),bp.Nouveau.objectRequest(e))},loadMoreScheduledActivities:function(e){e.preventDefault();var t="activity",s=u(e.currentTarget),i=this,d=+Number(i.scheduled_current_page)+1;0<d&&u("#buddypress .bb-action-popup-content .schedule-posts-content").length&&(s.hasClass("bb-page-item-deleted")&&(s.removeClass("bb-page-item-deleted"),d-=1),s.find("a").first().addClass("loading"),u("#buddypress #bb-schedule-posts_modal ul.bp-list li.activity-item").addClass("bb-pre-listed-page-item"),e={object:t,status:"scheduled",target:"#buddypress #bb-schedule-posts_modal .schedule-posts-content ul.bp-list",method:"append",template:"activity_schedule",page:d},1===d&&(e.method="reset",e.target="#buddypress #bb-schedule-posts_modal .schedule-posts-content"),u('#buddypress [data-bp-member-type-filter="'+t+'"]').length?e.member_type_id=u('#buddypress [data-bp-member-type-filter="'+t+'"]').val():u('#buddypress [data-bp-group-type-filter="'+t+'"]').length&&(e.group_type=u('#buddypress [data-bp-group-type-filter="'+t+'"]').val()),bp.Nouveau.objectRequest(e).done(function(e){!0===e.success&&(void 0!==e.data.contents&&""!==e.data.contents&&(e=u.parseHTML(e.data.contents),u.each(e,function(e,t){"LI"===t.nodeName&&u(t).hasClass("activity-item")&&u("#"+u(t).prop("id")+".bb-pre-listed-page-item").length&&u("#"+u(t).prop("id")+".bb-pre-listed-page-item").remove()})),s.remove(),i.scheduled_current_page=d,jQuery(window).scroll())}))},viewGroupSchedulePostModal:function(){var e,t,s;"scheduled_posts"===this.bbGetUrlParameter("action")&&(t=0,(e=this).bbRemoveUrlParameter("action"),s=setInterval(function(){u("#whats-new-form").hasClass("focus-in--empty")?(e.openSchedulePostModal(),clearInterval(s)):10<++t&&clearInterval(s)},200))},bbGetUrlParameter:function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");e=new RegExp("[\\?&]"+e+"=([^&#]*)").exec(location.search);return null===e?"":decodeURIComponent(e[1].replace(/\+/g," "))},bbRemoveUrlParameter:function(e){var t=window.location.href,s=t.split("?");if(2<=s.length){for(var i=encodeURIComponent(e)+"=",d=s[1].split(/[&;]/g),a=d.length;0<a--;)-1!==d[a].lastIndexOf(i,0)&&d.splice(a,1);t=s[0]+(0<d.length?"?"+d.join("&"):""),window.history.replaceState(null,null,t)}}},bp.Views.activitySchedulePost=Backbone.View.extend({tagName:"div",id:"bb-schedule-posts",className:"bb-schedule-posts",template:bp.template("activity-schedule-post"),events:{"click .bb-schedule-post_dropdown_button":"displayOptions","click .bb-schedule-post_action":"displayScheduleForm","click .bb-view-schedule-posts":"displaySchedulePosts","click .bb-view-all-scheduled-posts":"displaySchedulePosts","click #bb-schedule-posts_modal .bb-close-action-popup":"closeSchedulePosts","click .bb-schedule-activity-cancel":"cancelSchedulePost","click .bb-model-close-button":"cancelSchedulePost","click .bb-schedule-activity":"displayScheduleButton","change .bb-schedule-activity-meridian-wrap input":"validateScheduleTime","change .bb-schedule-activity-date-field":"validateScheduleTime","change .bb-schedule-activity-time-field":"validateScheduleTime","click .bb-activity-schedule_edit":"editScheduledPost","click .bb-activity-schedule_delete":"deleteScheduledPost","click .bb-schedule-activity-clear":"clearScheduledPost"},initialize:function(){this.model.on("change:activity_action_type change:activity_schedule_date_raw change:activity_schedule_date change:activity_schedule_time change:activity_schedule_meridiem",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this},displayOptions:function(e){e.preventDefault();e=u(e.target);e.hasClass("is_scheduled")&&e.closest(".activity-form").hasClass("bp-activity-edit")?e.closest(".bb-schedule-posts").find(".bb-schedule-post_action").trigger("click"):e.closest(".bb-schedule-post_dropdown_section").find(".bb-schedule-post_dropdown_list").toggleClass("is_open")},cancelSchedulePost:function(e){e.preventDefault(),u(e.target).closest("#bb-schedule-post_form_modal").hide()},displayScheduleForm:function(e){e.preventDefault();var e=u(e.target).closest(".bb-schedule-posts");e.find(".bb-schedule-post_dropdown_list").removeClass("is_open"),e.find(".bb-schedule-post_modal #bb-schedule-post_form_modal").show(),void 0!==jQuery.fn.datetimepicker&&(e=new Date,u(".bb-schedule-post_dropdown_section .bb-schedule-activity-date-field").datetimepicker({format:"Y-m-d",timepicker:!1,mask:!1,minDate:0,maxDate:new Date(e.getFullYear(),e.getMonth(),e.getDate()+90),yearStart:e.getFullYear(),defaultDate:e,scrollMonth:!1,scrollTime:!1,scrollInput:!1,className:"bb-schedule-activity-date-wrap"}),u(".bb-schedule-post_dropdown_section .bb-schedule-activity-time-field").datetimepicker({datepicker:!1,format:"h:i",formatTime:"h:i",hours12:!0,step:5,className:"bb-schedule-activity-time-picker"})),u(".bb-server-date").length&&u(".bb-server-date").text(bp.Nouveau.bbServerTime().date),u(".bb-server-year").length&&u(".bb-server-year").text(bp.Nouveau.bbServerTime().year),u(".bb-server-time").length&&u(".bb-server-time").text(bp.Nouveau.bbServerTime().time)},displaySchedulePosts:function(e){e.preventDefault();e=u(e.target).closest(".bb-schedule-posts");e.find(".bb-schedule-post_dropdown_list").removeClass("is_open"),e.find("#bb-schedule-post_form_modal").hide(),e.find("#bb-schedule-posts_modal").show(),e.find("#bb-schedule-posts_modal .bb-action-popup-content:not(.bb-scrolling)").on("scroll",function(){u(window).scroll(),u(this).addClass("bb-scrolling")})},closeSchedulePosts:function(e){e.preventDefault();e=u(e.target).closest("#bb-schedule-posts_modal");e.find(".bb-action-popup-content").removeClass("has-content has-no-content"),e.find(".bb-action-popup-content .schedule-posts-content").removeAttr("style").html(""),e.hide(),bp.Nouveau.SchedulePostView&&(u("#activity-header .bb-model-close-button").trigger("click"),bp.Nouveau.SchedulePostView=!1),bp.Nouveau.SchedulePostViewHidden&&(u(".bb-schedule-post_dropdown_section").addClass("bp-hide"),bp.Nouveau.SchedulePostViewHidden=!1)},displayScheduleButton:function(e){e.preventDefault();var t=u(e.target).closest(".bb-schedule-posts"),s=t.find(".bb-schedule-activity-time-field").val(),i=t.find(".bb-schedule-activity-date-field").val(),t=t.find('input[name="bb-schedule-activity-meridian"]:checked').val(),d=new Date(i+"T00:00:00"),a=d.toLocaleString("en-us",{month:"short"})+" "+d.getDate(),l=new Date(i+" "+s+" "+t),c=new Date(bp.Nouveau.bbServerTime().currentServerTime),o=new Date(c),n=(o.setMonth(c.getMonth()+3),u("#whats-new-form"));l<c?(Backbone.trigger("onError",BP_Nouveau.activity_schedule.strings.scheduleWarning,"warning"),setTimeout(function(){Backbone.trigger("cleanFeedBack")},3e3),n.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),n.addClass("focus-in--empty")):d>o.getTime()?(c>o.getTime()&&u(".bb-schedule-activity").attr("disabled","disabled"),Backbone.trigger("onError",BP_Nouveau.activity_schedule.strings.scheduleWarning,"warning"),setTimeout(function(){Backbone.trigger("cleanFeedBack")},3e3),n.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide"),n.addClass("focus-in--empty")):(n.removeClass("focus-in--empty"),this.model.set("activity_action_type","scheduled"),this.model.set("activity_schedule_date_raw",i),this.model.set("activity_schedule_date",a),this.model.set("activity_schedule_time",s),this.model.set("activity_schedule_meridiem",t),Backbone.trigger("cleanFeedBack"),d=(l=u("#whats-new-form")).find("#bp-item-opt-"+this.model.attributes.item_id).data("allow-schedule-post"),_.isUndefined(d)&&!_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)&&!0===BP_Nouveau.activity_schedule.params.can_schedule_in_feed&&(d="enabled"),_.isUndefined(d)||"enabled"!==d?(this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),this.model.set("schedule_allowed",null),l.find(".bb-schedule-post_dropdown_section").addClass("bp-hide")):l.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide")),u(e.target).closest("#bb-schedule-post_form_modal").hide()},validateScheduleTime:function(){""!==u(".bb-schedule-activity-date-field").val()&&""!==u(".bb-schedule-activity-time-field").val()?u(".bb-schedule-activity").removeAttr("disabled"):u(".bb-schedule-activity").attr("disabled","disabled")},editScheduledPost:function(e){e.preventDefault();var t,s=u(e.target).closest("li.activity-item"),i=u(e.target);i.parent().hasClass("bb-activity-schedule_edit")&&(e.preventDefault(),e=s.data("bp-activity"),t=""!==s.data("link-url")?s.data("link-url"):null,"scheduled"===e.status&&(s=s.data("bb-scheduled-time"),e.activity_schedule_date_raw=s.date_raw,e.activity_schedule_date=s.date,e.activity_schedule_time=s.time,e.activity_schedule_meridiem=s.meridiem),void 0!==e)&&(bp.Nouveau.Activity.postForm.displayEditActivityForm(e,t),i.closest("li").hasClass("groups")?u("#bp-nouveau-activity-form").addClass("group-activity"):u("#bp-nouveau-activity-form").removeClass("group-activity"),void 0!==bp.Nouveau.Media)&&void 0!==bp.Nouveau.Media.Theatre&&(bp.Nouveau.Media.Theatre.is_open_media||bp.Nouveau.Media.Theatre.is_open_document)&&(u(document).find(".bb-close-media-theatre").trigger("click"),u(document).find(".bb-close-document-theatre").trigger("click"))},deleteScheduledPost:function(e){e.preventDefault();var t,s=confirm(BP_Nouveau.activity_schedule.strings.confirmDeletePost),i=u(e.target).parent(),d=u(e.target).closest("li.activity-item"),a=d.data("bp-activity-id"),l=u(e.target).closest(".schedule-posts-content");s&&i.hasClass("bb-activity-schedule_delete")&&(i.addClass("loading"),e={action:"delete_scheduled_activity",id:a,_wpnonce:BP_Nouveau.activity_schedule.params.scheduled_post_nonce,is_single:i.closest("[data-bp-single]").length},t=d,bp.ajax.post(e).done(function(){i.removeClass("loading"),u(t).remove(),0===l.find("li").length&&l.closest(".bb-action-popup-content").addClass("has-no-content").removeClass("has-content"),u(document).trigger("bb_trigger_toast_message",[BP_Nouveau.activity_schedule.strings.successDeletionTitle,"<div>"+BP_Nouveau.activity_schedule.strings.successDeletionDesc+"</div>","delete",null,!0]),u("#buddypress #bb-schedule-posts_modal .load-more").addClass("bb-page-item-deleted")}).fail(function(e){i.removeClass("loading");e='<aside class="bp-feedback bp-messages bp-template-notice error"><span class="bp-icon" aria-hidden="true"></span><p>'+e.feedback+"</p></aside>";t.closest(".schedule-posts-content").prepend(e),t.closest(".schedule-posts-content").find(".bp-feedback").hide().fadeIn(500)}))},clearScheduledPost:function(e){e.preventDefault(),this.model.set("edit_activity",!1),this.model.set("activity_action_type",null),this.model.set("activity_schedule_date_raw",null),this.model.set("activity_schedule_date",null),this.model.set("activity_schedule_time",null),this.model.set("activity_schedule_meridiem",null),u(e.target).closest("#bb-schedule-post_form_modal").hide();var e=u("#whats-new-form"),t=e.find("#bp-item-opt-"+this.model.attributes.item_id).data("allow-schedule-post");_.isUndefined(t)&&!_.isUndefined(BP_Nouveau.activity_schedule.params.can_schedule_in_feed)&&!0===BP_Nouveau.activity_schedule.params.can_schedule_in_feed&&(t="enabled"),_.isUndefined(t)||"enabled"!==t||e.find(".bb-schedule-post_dropdown_section").removeClass("bp-hide")}}),bp.Views.PostScheduleTime=Backbone.View.extend({tagName:"div",id:"activity-schedule-section",template:bp.template("activity-schedule-details"),initialize:function(){this.model.on("change",this.render,this)},render:function(){return this.$el.html(this.template(this.model.attributes)),this}}),bp.Nouveau.SchedulePost.start())}((bp,jQuery));